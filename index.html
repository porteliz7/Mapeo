<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Granja de Miner√≠a Bitcoin</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fondo suave */
        }
        /* Estilos de los slots de m√°quina */
        .slot {
            transition: all 0.2s;
            cursor: pointer;
            /* Aplicar estilo de cuadr√≠cula/rack */
            @apply flex flex-col items-center justify-center text-xs font-semibold rounded-lg shadow-inner w-full h-12 p-1 border-2; 
            min-width: 40px; /* Asegurar que no se colapse en m√≥vil */
        }
        .slot-empty {
            @apply bg-gray-50 border-dashed border-gray-300 text-gray-400 hover:bg-green-50 hover:border-green-400 hover:text-green-600;
        }
        .slot-running {
            @apply bg-green-500 border-green-700 text-white shadow-lg hover:bg-green-600;
        }
        .slot-error {
            @apply bg-red-500 border-red-700 text-white shadow-lg hover:bg-red-600 animate-pulse;
        }
        .slot-off {
            @apply bg-gray-500 border-gray-700 text-white shadow-lg hover:bg-gray-600;
        }

        /* Contenedor principal del rack para centrar */
        .rack-container {
            max-width: 500px;
        }

        /* Estilo para el contenedor del modal */
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.6);
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="min-h-screen">
        <!-- Barra Superior / Header -->
        <header class="bg-gray-900 text-white shadow-lg p-4 md:p-6 sticky top-0 z-10">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 id="header-title" class="text-2xl font-bold mb-2 md:mb-0 cursor-pointer hover:text-indigo-400 transition duration-300" onclick="setView('containers')">
                    üó∫Ô∏è Mapeo de Granja de Miner√≠a
                </h1>
                <div id="status-summary" class="text-sm font-medium text-gray-300">
                    Cargando estado...
                </div>
            </div>
        </header>

        <!-- Contenedor Principal de la Aplicaci√≥n -->
        <div id="main-content" class="container mx-auto p-4 md:p-8">
            <!-- El contenido se renderizar√° aqu√≠ din√°micamente -->
            <div class="flex justify-center items-center h-64 text-gray-500" id="loading-initial">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Inicializando Firebase y Auth...
            </div>
        </div>
    </div>

    <!-- Modal para Agregar/Editar M√°quina -->
    <div id="rig-modal" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all duration-300 scale-95 opacity-0" id="modal-content-wrapper">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-4">Detalles de Puesto</h3>
            <p class="text-sm text-gray-500 mb-4">Ubicaci√≥n: <span id="modal-location-text" class="font-mono bg-gray-100 px-2 py-1 rounded"></span></p>

            <div id="form-content">
                <!-- El formulario se inyectar√° aqu√≠ (Agregar o Editar) -->
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Dependencias de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDocs, deleteDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuraci√≥n de Firestore
        setLogLevel('debug');

        // --- GESTI√ìN DE VARIABLES GLOBALES DE CANVAS/FIREBASE ---
        
        // Comprobaci√≥n de si las variables globales de Firebase est√°n definidas.
        // Si no lo est√°n, asumimos que estamos en un entorno externo (local, GitHub Pages) y activamos el modo demo.
        const HAS_CANVAS_CONFIG = typeof __app_id !== 'undefined';
        
        const appId = HAS_CANVAS_CONFIG ? __app_id : 'default-app-id';
        const rawFirebaseConfig = HAS_CANVAS_CONFIG ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = HAS_CANVAS_CONFIG ? __initial_auth_token : null;
        
        // Define la configuraci√≥n de Firebase para evitar errores de inicializaci√≥n.
        // Usamos una clave vac√≠a como bandera para el MODO DEMO.
        const firebaseConfig = rawFirebaseConfig || { 
            apiKey: "DEMO_MODE_PLACEHOLDER", // Banderas para el modo demo
            authDomain: "demo.firebaseapp.com",
            projectId: "demo-project"
        };

        const IS_DEMO_MODE = !HAS_CANVAS_CONFIG || firebaseConfig.apiKey === "DEMO_MODE_PLACEHOLDER" || firebaseConfig.apiKey === "YOUR_API_KEY"; 

        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false;

        // Estructura de la Granja
        const LAYOUT = {
            CONTAINERS: 3, // C1, C2, C3
            SHELVES: 8,    // S1 a S8
            SECTIONS: 7,   // T1 a T7 (Filas en el rack)
            POSITIONS: 5   // P1 a P5 (Columnas en el rack)
        };

        // Estado de la Aplicaci√≥n
        let rigsData = new Map(); // Mapa para almacenar los datos de las m√°quinas (locationID -> rigObject)
        let currentView = { name: 'containers', container: null, shelf: null }; // Estado de la vista actual

        // Referencias de Elementos DOM
        const mainContent = document.getElementById('main-content');
        const headerTitle = document.getElementById('header-title');
        const statusSummary = document.getElementById('status-summary');
        const modal = document.getElementById('rig-modal');
        const modalContentWrapper = document.getElementById('modal-content-wrapper');
        const modalTitle = document.getElementById('modal-title');
        const modalLocationText = document.getElementById('modal-location-text');
        const formContent = document.getElementById('form-content');

        // --- FUNCIONES DE INICIALIZACI√ìN Y AUTENTICACI√ìN ---

        const createDemoData = () => {
            const demoMap = new Map();
            // C1, Estante 1
            demoMap.set('C1-S1-T1-P1', { id: 'S19-A123', location: 'C1-S1-T1-P1', status: 'running', docId: 'demo1' });
            demoMap.set('C1-S1-T1-P2', { id: 'S19-B456', location: 'C1-S1-T1-P2', status: 'error', docId: 'demo2' });
            demoMap.set('C1-S1-T7-P5', { id: 'S19-LAST', location: 'C1-S1-T7-P5', status: 'running', docId: 'demo4' });

            // C2, Estante 5
            demoMap.set('C2-S5-T3-P4', { id: 'M30-X999', location: 'C2-S5-T3-P4', status: 'off', docId: 'demo3' });
            return demoMap;
        };

        const startDemoMode = () => {
            console.warn("ADVERTENCIA: Usando Modo Demo. Los datos NO ser√°n persistentes. La aplicaci√≥n se cargar√° con datos de ejemplo.");
            isAuthReady = true;
            userId = 'demo-user-123';
            document.getElementById('loading-initial').classList.add('hidden');
            rigsData = createDemoData(); 
            renderApp(); 
            updateSummary(rigsData.size, Array.from(rigsData.values()).filter(r => r.status === 'running').length, Array.from(rigsData.values()).filter(r => r.status === 'error').length, LAYOUT.CONTAINERS * LAYOUT.SHELVES * LAYOUT.SECTIONS * LAYOUT.POSITIONS);
        };

        const initializeFirebase = async () => {
            // Si est√° en Modo Demo, salta la inicializaci√≥n de Firebase
            if (IS_DEMO_MODE) {
                return startDemoMode();
            }

            // Inicializaci√≥n real de Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        setupDataListener();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error al autenticar:", error.message);
                            isAuthReady = true;
                            userId = `unauthenticated-${crypto.randomUUID()}`;
                            setupDataListener();
                        }
                    }
                });
                
                document.getElementById('loading-initial').classList.add('hidden'); // Ocultar despu√©s de la inicializaci√≥n exitosa

            } catch (e) {
                console.error("Fallo al inicializar Firebase. Activando Modo Demo de respaldo:", e);
                startDemoMode(); // Fallback completo al modo demo si la inicializaci√≥n real falla
            }
        };

        // --- FUNCI√ìN DE GESTI√ìN DE DATOS (FIRESTORE) ---

        const getCollectionRef = () => {
            const path = `/artifacts/${appId}/public/data/mining_rigs`;
            return collection(db, path);
        };

        const setupDataListener = () => {
            if (!isAuthReady || IS_DEMO_MODE || !db) return;

            const q = query(getCollectionRef());

            onSnapshot(q, (snapshot) => {
                const newRigsData = new Map();
                let totalRigs = 0;
                let totalRunning = 0;
                let totalError = 0;
                const totalSlots = LAYOUT.CONTAINERS * LAYOUT.SHELVES * LAYOUT.SECTIONS * LAYOUT.POSITIONS;

                snapshot.forEach((doc) => {
                    const rig = doc.data();
                    newRigsData.set(rig.location, { ...rig, docId: doc.id });
                    totalRigs++;
                    if (rig.status === 'running') totalRunning++;
                    if (rig.status === 'error') totalError++;
                });

                rigsData = newRigsData;
                renderApp(); 
                updateSummary(totalRigs, totalRunning, totalError, totalSlots);
            }, (error) => {
                console.error("Error al escuchar cambios en Firestore:", error);
            });
        };

        const updateSummary = (totalRigs, totalRunning, totalError, totalSlots) => {
            const totalAvailable = totalSlots - totalRigs;
            statusSummary.innerHTML = `
                <span class="text-green-400">Activas: ${totalRunning}</span> / 
                <span class="text-red-400">Error: ${totalError}</span> / 
                <span class="text-indigo-400">Disponibles: ${totalAvailable}</span> / 
                <span class="font-bold text-gray-400">Total Puestos: ${totalSlots}</span>
            `;
        };

        const saveRig = async (locationId, machineId, status) => {
            // Modo Demo
            if (IS_DEMO_MODE) {
                const isNew = !rigsData.has(locationId);
                const docId = isNew ? `demo-${Math.random().toString(36).substring(2, 9)}` : rigsData.get(locationId)?.docId;
                
                rigsData.set(locationId, { id: machineId.trim(), location: locationId, status: status, docId: docId });
                renderApp(); 
                closeModal();
                updateSummary(rigsData.size, Array.from(rigsData.values()).filter(r => r.status === 'running').length, Array.from(rigsData.values()).filter(r => r.status === 'error').length, LAYOUT.CONTAINERS * LAYOUT.SHELVES * LAYOUT.SECTIONS * LAYOUT.POSITIONS);
                return;
            }

            // Modo Firebase
            try {
                const [C, S, T, P] = locationId.split('-');
                const rigObject = {
                    id: machineId.trim(),
                    location: locationId,
                    container: parseInt(C.slice(1)),
                    shelf: parseInt(S.slice(1)),
                    section: parseInt(T.slice(1)),
                    position: parseInt(P.slice(1)),
                    status: status,
                    lastUpdated: new Date().toISOString(),
                    createdBy: userId
                };

                const existingRig = rigsData.get(locationId);
                
                if (existingRig) {
                    const rigDocRef = doc(db, getCollectionRef().path, existingRig.docId);
                    await updateDoc(rigDocRef, { id: rigObject.id, status: rigObject.status, lastUpdated: rigObject.lastUpdated });
                } else {
                    await addDoc(getCollectionRef(), rigObject);
                }
                closeModal();
            } catch (e) {
                console.error("Error al guardar la m√°quina:", e);
                console.error("Error: Revise la consola.");
            }
        };

        const deleteRig = async (docId, locationId) => {
            // Modo Demo
            if (IS_DEMO_MODE) {
                rigsData.delete(locationId);
                renderApp(); 
                closeModal();
                updateSummary(rigsData.size, Array.from(rigsData.values()).filter(r => r.status === 'running').length, Array.from(rigsData.values()).filter(r => r.status === 'error').length, LAYOUT.CONTAINERS * LAYOUT.SHELVES * LAYOUT.SECTIONS * LAYOUT.POSITIONS);
                return;
            }
            
            // Modo Firebase
            try {
                if (!docId) throw new Error("ID de documento no proporcionado.");
                
                const rigDocRef = doc(db, getCollectionRef().path, docId);
                await deleteDoc(rigDocRef);
                closeModal();
            } catch (e) {
                console.error("Error al eliminar la m√°quina:", e);
                console.error("Error: Revise la consola.");
            }
        };


        // --- FUNCIONES DE RENDERIZADO DE VISTA ---

        const renderApp = () => {
            switch (currentView.name) {
                case 'containers':
                    renderContainers();
                    break;
                case 'shelves':
                    renderShelves(currentView.container);
                    break;
                case 'slots':
                    renderSlots(currentView.container, currentView.shelf);
                    break;
                default:
                    renderContainers();
            }
        };

        const setView = (viewName, container = null, shelf = null) => {
            currentView = { name: viewName, container: container, shelf: shelf };
            renderApp();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        // Renderiza la vista de los 3 Contenedores
        const renderContainers = () => {
            headerTitle.innerHTML = `üó∫Ô∏è Mapeo de Granja de Miner√≠a`;

            mainContent.innerHTML = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Contenedores (C1 - C${LAYOUT.CONTAINERS})</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${Array.from({ length: LAYOUT.CONTAINERS }, (_, c) => {
                        const containerNum = c + 1;
                        const containerPrefix = `C${containerNum}-`;
                        const containerRigs = Array.from(rigsData.values()).filter(rig => rig.location.startsWith(containerPrefix));
                        const totalRigs = containerRigs.length;
                        const totalRunning = containerRigs.filter(r => r.status === 'running').length;
                        const totalError = containerRigs.filter(r => r.status === 'error').length;
                        const totalSlots = LAYOUT.SHELVES * LAYOUT.SECTIONS * LAYOUT.POSITIONS;

                        return `
                            <div onclick="setView('shelves', ${containerNum})"
                                class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-indigo-500 cursor-pointer hover:shadow-2xl hover:border-indigo-600 transition duration-300">
                                <h3 class="text-2xl font-bold text-gray-900 mb-2">Contenedor C${containerNum}</h3>
                                <p class="text-gray-500 mb-4">Capacidad: ${totalSlots} puestos</p>
                                <div class="space-y-1 text-sm">
                                    <p class="font-medium text-gray-700">Ocupados: <span class="text-indigo-600 font-bold">${totalRigs}</span></p>
                                    <p class="font-medium text-gray-700">Activos: <span class="text-green-600 font-bold">${totalRunning}</span></p>
                                    <p class="font-medium text-gray-700">En Error: <span class="text-red-600 font-bold">${totalError}</span></p>
                                </div>
                                <div class="mt-4 h-2 bg-gray-200 rounded-full">
                                    <div class="h-2 bg-indigo-500 rounded-full" style="width: ${(totalRigs / totalSlots) * 100}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };

        // Renderiza la vista de los 8 Estantes de un Contenedor (Ahora en cuadr√≠cula)
        const renderShelves = (containerNum) => {
            headerTitle.innerHTML = `C${containerNum} | Estantes`;

            const breadcrumb = `
                <button onclick="setView('containers')" class="text-indigo-500 hover:text-indigo-700">Contenedores</button>
                <span class="mx-2 text-gray-400">/</span>
                <span class="font-bold text-gray-700">C${containerNum}</span>
            `;

            mainContent.innerHTML = `
                <nav class="mb-6 text-sm">${breadcrumb}</nav>
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Mapa de Estantes en C${containerNum}</h2>
                
                <!-- Cuadr√≠cula de Estantes -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4"> 
                    ${Array.from({ length: LAYOUT.SHELVES }, (_, s) => {
                        const shelfNum = s + 1;
                        const shelfPrefix = `C${containerNum}-S${shelfNum}-`;
                        const shelfRigs = Array.from(rigsData.values()).filter(rig => rig.location.startsWith(shelfPrefix));
                        const totalRigs = shelfRigs.length;
                        const totalRunning = shelfRigs.filter(r => r
